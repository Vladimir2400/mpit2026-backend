#!/bin/bash

# ะกะบัะธะฟั ะดะปั ัะฐะทัะฐะฑะพัะบะธ ั ะฐะฒัะพะผะฐัะธัะตัะบะธะผ ััะฝะฝะตะปะตะผ ะธ ะทะฐะฟััะบะพะผ ะฑัะบะตะฝะดะฐ

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

echo "๐ ะะฐะฟััะบ ัะตะถะธะผะฐ ัะฐะทัะฐะฑะพัะบะธ..."
echo ""

# ะคัะฝะบัะธั ะดะปั ะพัะธััะบะธ ะฟัะธ ะฒััะพะดะต
cleanup() {
    echo ""
    echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐั ะฟัะพัะตััั..."

    if [ ! -z "$TUNNEL_PID" ]; then
        echo "   ะััะฐะฝะฐะฒะปะธะฒะฐั ััะฝะฝะตะปั (PID: $TUNNEL_PID)..."
        kill $TUNNEL_PID 2>/dev/null || true
    fi

    if [ ! -z "$BACKEND_PID" ]; then
        echo "   ะััะฐะฝะฐะฒะปะธะฒะฐั ะฑัะบะตะฝะด (PID: $BACKEND_PID)..."
        kill $BACKEND_PID 2>/dev/null || true
    fi

    echo "โ ะัะต ะฟัะพัะตััั ะพััะฐะฝะพะฒะปะตะฝั"
    exit 0
}

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะพะฑัะฐะฑะพััะธะบ ัะธะณะฝะฐะปะพะฒ
trap cleanup SIGINT SIGTERM EXIT

# ะัะพะฒะตััะตะผ ััะพ ะฟะพัั 8080 ัะฒะพะฑะพะดะตะฝ
if lsof -Pi :8080 -sTCP:LISTEN -t >/dev/null 2>&1 ; then
    echo "โ ะัะธะฑะบะฐ: ะะพัั 8080 ัะถะต ะทะฐะฝัั!"
    echo "   ะะฐะนะดะตะฝะฝัะต ะฟัะพัะตััั:"
    lsof -Pi :8080 -sTCP:LISTEN
    echo ""
    echo "   ะงัะพะฑั ะพัะฒะพะฑะพะดะธัั ะฟะพัั, ะฒัะฟะพะปะฝะธัะต:"
    echo "   sudo fuser -k 8080/tcp"
    exit 1
fi

# ะะฐะฟััะบะฐะตะผ ััะฝะฝะตะปั ะฒ ัะพะฝะต
echo "๐ ะกะพะทะดะฐั SSH ััะฝะฝะตะปั..."
"$SCRIPT_DIR/tunnel.sh" > /tmp/tunnel.log 2>&1 &
TUNNEL_PID=$!

echo "   ะขัะฝะฝะตะปั ะทะฐะฟััะตะฝ ะฒ ัะพะฝะต (PID: $TUNNEL_PID)"
echo "   ะะพะณะธ ััะฝะฝะตะปั: /tmp/tunnel.log"
echo ""

# ะะดะตะผ ะฟะฐัั ัะตะบัะฝะด ััะพะฑั ััะฝะฝะตะปั ัััะฐะฝะพะฒะธะปัั
echo "โณ ะะถะธะดะฐะฝะธะต ัััะฐะฝะพะฒะบะธ ััะฝะฝะตะปั..."
sleep 3

# ะัะพะฒะตััะตะผ ััะพ ััะฝะฝะตะปั ะถะธะฒ
if ! ps -p $TUNNEL_PID > /dev/null 2>&1; then
    echo "โ ะขัะฝะฝะตะปั ะฝะต ะทะฐะฟัััะธะปัั!"
    echo "   ะัะพะฒะตัััะต ะปะพะณะธ: cat /tmp/tunnel.log"
    exit 1
fi

echo "โ ะขัะฝะฝะตะปั ัััะฐะฝะพะฒะปะตะฝ"
echo ""

# ะะตัะตัะพะดะธะผ ะฒ ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ
cd "$PROJECT_DIR"

# ะะฐะฟััะบะฐะตะผ ะฑัะบะตะฝะด
echo "๐ง ะะฐะฟััะบ ะฑัะบะตะฝะดะฐ..."
echo "   ะะธัะตะบัะพัะธั: $PROJECT_DIR"
echo ""

go run cmd/server/main.go &
BACKEND_PID=$!

echo ""
echo "โ ะัะบะตะฝะด ะทะฐะฟััะตะฝ (PID: $BACKEND_PID)"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ ะะตะถะธะผ ัะฐะทัะฐะฑะพัะบะธ ะฐะบัะธะฒะตะฝ!"
echo ""
echo "๐ก ะะพะบะฐะปัะฝัะน ะฑัะบะตะฝะด: http://localhost:8080"
echo "๐ ะฃะดะฐะปะตะฝะฝัะน ะดะพัััะฟ: https://urban-match.run.place/api/"
echo ""
echo "๐ก ะะฐะถะผะธัะต Ctrl+C ะดะปั ะพััะฐะฝะพะฒะบะธ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# ะะดะตะผ ะทะฐะฒะตััะตะฝะธั ะฑัะบะตะฝะดะฐ
wait $BACKEND_PID
